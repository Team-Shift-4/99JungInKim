# PostgreSQL: HA, Load Balancing, Replication

## 로그 전달 대기 서버

연속 아카이빙을 사용하여 기본 서버가 실패할 경우 작업을 인계할 준비가 된 하나 이상의 대기 서버가 있는 HA 클러스터 구성을 만들 수 있다.
이 기능을 Warm standby나 Log shipping이라고 한다.

기본 서버와 대기 서버는 함께 작동해 이 기능을 제공하나 서버는 느슨하게 연결되어 있다.
기본 서버는 연속 아카이빙 모드로 작동하고 대기 서버는 연속 복구 모드로 작동해 기본에서 WAL 파일을 읽는다.
이 기능을 활성화하기 위해 DB 테이블을 변경할 필요가 없고 기본 서버에 상대적으로 낮은 성능 영향을 미친다.

한 데이터베이스 서버에서 다른 데이터베이스 서버로 WAL 레코드를 직접 이동하는 것은 일반적으로 Log shipping(로그 전달)이라고 한다.
PostgreSQL은 WAL 레코드를 한 번에 하나의 파일(WAL 세그먼트)로 전송해 파일 기반 로그 전달을 구현한다.
WAL 파일(16MB)는 거리에 관계 없이 쉽고 저렴하게 옮길 수 있다.
이 기술에 필요한 대역폭은 주 서버의 트랜잭션 속도에 따라 다르다.
레코드 기반 로그 전달은 보다 세분화되어 있으며 네트워크 연결을 통해 점진적으로 WAL 변경 사항을 스트리밍 한다.

로그 전달은 비동기식이라는 점에 유의해야 한다.
즉 WAL 레코드는 트랜잭션 커밋 후 전달된다.
결과적으로 기본 서버에 심각한 오류가 발생하면 데이터가 손실될 가능성이 있다.
전달되지 않은 트랜잭션은 손실된다.
파일 기반 로그 전달에서 데이터 손실 기간의 크기는 `archive_timeout` 파라미터를 사용해 제한할 수 있으며 이 매개변수는 몇 초 정도로 낮게 설정할 수 있다.
낮게 설정하면 파일 전달에 필요한 대역폭을 크게 증가시킨다.
스트리밍 복제를 사용하면 데이터 손실 기간이 더 작아진다.

복구 성능이 충분히 우수해 대기가 활성화된 후 일반적으로 완전 가용성에 도달하기까지 몇 분 밖에 걸리지 않는다.
결과적으로 이를 HA를 제공하는 Warm standby 구성이라고 한다.
보관된 기본 백업에서 서버를 복원하고 Rollforward하는 데 시간이 훨씬 더 걸리므로 이 기술은 HA가 아닌 재해 복구를 위한 솔루션만 제공한다.
대기 서버는 읽기 전용 쿼리에서도 사용할 수 있으며 이를 Hot Standby 서버라고 한다.

### Planning

적어도 DB 서버의 관점에서 가능한 한 유사하도록 주 서버와 대기 서버를 생성하는 것이 좋다.
테이블스페이스와 관련된 경로 이름은 수정되지 않은 채 전달되므로 해당 기능을 사용하는 경우 기본 서버와 대기 서버 모두 테이블스페이스에 대해 동일한 마운트 경로를 가져야 한다.
CREATE TABLESPACE가 기본 서버에서 실행되면 명령이 실행되기 전에 필요한 새 마운트 지점이 기본과 모든 대기 서버에서 생성되어야 한다.
하드웨어가 정확히 동일할 필요는 없으나 두 개의 동일한 시스템을 유지하는 것이 응용 프로그램과 시스템의 수명 동안 두 개의 서로 다른 시스템을 유지하는 것 보다는 쉽다.
어떤 경우든 하드웨어 아키텍처는 동일해야 한다.
32비트에서 64비트 시스템으로의 전송은 작동하지 않는다.

일반적으로 서로 다른 메이저 PostgreSQL 배포 수준을 실행하는 서버 간의 로그 전달은 불가능하다.
마이너 배포 업그레이드 중에 디스크 형식을 변경하지 않는 것이 PostgreSQL 글로벌 개발 그룹의 정책이여서 기본 서버와 대기 서버에서 서로 다른 릴리즈 레벨을 실행하면 성공적으로 작동한다.
그러나 이에 대한 공식적인 지원은 제공되지 않으며 기본과 대기 서버를 가능하다면 동일한 배포 수준으로 유지하는 것이 좋다.
새로운 마이너 배포로 업데이트할 때 가장 안전한 정책은 대기 서버를 먼저 업데이트 하는 것이다.
새로운 마이너 배포는 이전 마이너 배포에서 WAL 파일을 읽을 수 있는 가능성이 이전이 이후를 읽는 것보다 더 높다.

### 대기 서버 운영

대기 모드에서 서버는 주 서버로부터 받은 WAL을 지속적으로 적용한다.
대기 서버는 WAL 아카이브나 TCP 연결(스트리밍 복제)을 통해 마스터에서 직접 WAL을 읽을 수 있다.
대기 서버 또한 대기 클러스터의 `pg_wal` 디렉터리에 있는 WAL을 복원하려고 시도한다.
일반적으로 서버가 다시 시작된 후 다시 시작되기 전에 주 서버에서 스트리밍된 WAL을 다시 재생할 때 발생하나 언제든지 수동으로 파일을 `pg_wal`에 복사하여 재생되도록 할 수 있다.

시작할 때 대기 서버는 아카이브 위치에서 사용 가능한 모든 WAL을 복원하고 `resotre_command`를 호출하여 시작한다.
사용 가능한 WAL 끝에 도달하고 `restore_command`가 실패하면 `pg_wal` 디렉터리에서 사용 가능한 WAL을 복원하려고 시도한다.
사용 가능한 WAL 복원이 실패하고 스트리밍 복제가 구성된 경우 대기 서버는 기본 서버에 연결을 시도하고 아카이브나 `pg_wal`에서 찾은 마지막 유효한 레코드에서 스트리밍 WAL을 시작한다.
실패하거나 스트리밍 복제가 구성되지 않았거나 나중에 연결이 끊어지면 대기 서버는 1단계로 돌아가 아카이브에서 파일을 다시 복원하려고 시도한다.
아카이브, `pg_wal`, 스트리밍 복제를 통한 이 재시도 루프는 서버가 중지되거나 장애 조치가 트리거 파일에 의해 트리거될 때 까지 계속된다.

대기 모드가 종료되고 `pg_ctl promote`가 실행되거나 트리거 파일이 발경되면 서버가 정상 작동으로 전환된다.
장애 조치 전 아카이브나 `pg_wal`에서 즉시 사용 가능한 모든 WAL이 복원되나 마스터에 연결하려는 시도는 하지 않는다.

### 대기 서버용 주 서버 준비

주 서버에서 대기 서버에서 접근할 수 있는 아카이브 디렉터리로 연속 보관을 설정한다.
아카이브 위치는 주 서버가 다운된 경우에도 대기 서버에서 접근할 수 있어야 한다.
주 서버가 아니라 대기 서버 자체나 다른 신뢰할 수 있는 서버에 존재해야 한다.

스트리밍 복제를 사용하려면 대기 서버에서 복제 연결을 허용하도록 기본 서버에서 인증을 설정해야 한다.
인증 설정은 역할을 생성하고 복제로 설정된 DB 필드와 함께 `pg_hba.conf`에 적절한 항목을 제공한다,
`max_wal_senders`가 기본 서버의 구성 파일에서 충분한 값으로 설정해야 한다.
복제 슬롯을 사용할 경우 `max_replication_slots`도 충분한 값으로 설정해야 한다.

### 대기 서버 설정

대기 서버를 설정하려면 주 서버에서 가져온 기본 백업을 복원한다.
대기의 클러스터 데이터 디렉터리에 복구 명령 파일 `recovery.conf`를 생성하고 `standby_mode`를 켠다.
WAL 아카이브에서 파일을 복사하는 간단한 명령으로 `resotre_command`를 설정한다.
HA를 위해 대기 서버를 여러 개 보유할 계획일 경우 `recovery_target_timeline`을 `latest`로 설정해 대기 서버가 장애 조치 시 다른 대기 서버로 발생하는 타임라인 변경을 따르도록 한다.

내장 대기 모드와 함께 pg_standby나 유사한 도구를 쓰면 안된다.
파일이 존재하지 않는 경우 `restore_command`는 즉시 반환해야 한다.
서버는 필요한 겨으이 명령을 다시 시도한다.

스트리밍 복제를 사용하려면 호스트 이름(이나 IP 주소)와 기본 서버에 연결하는 데 필요한 추가 정보를 포함해 libpq 연결 문자열로 `primary_conninfo` 를 연결한다.
주 서버가 인증을 위해 암호를 필요로 하는 경우에도 암호를 `primary_conninfo`에 저장하면 된다.

HA를 위해 대기 서버를 설정하는 경우 대기 서버가 장애 조치 후 주 서버로 작동하므로 기본 서버와 같은 WAL 보관, 연결 및 인증을 설정해야 한다.

WAL 아카이브를 사용하는 경우 대기 서버에서 더 이상 필요하지 않은 파일을 제거하기 위해 `archive_cleanup_command` 매개변수를 사용해 크기를 최소화 할 수 있다.
pg_archivecleanup 유틸리티는 일반적인 단일 대기 구성에서 `archive_cleanup_command`와 함께 사용되도록 설계되었다.
백업 목적으로 아카이브를 사용하는 경우 대기에서 더 이상 필요하지 않더라도 최소한 최신 기본 백업에서 복구하는 데 필요한 파일을 유지해야 한다.

`recovery.conf`의 예시이다.

```bash
standby_mode='on'
primary_conninfo='host=172.16.0.102 port=5432 user=postgres password=postgres'
restore_command=`cp /<archive_path>/%f %p`

```

