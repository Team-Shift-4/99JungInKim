# PostgreSQL: Snapshot

테이블의 논리적 복제는 일반적으로 게시자 DB에서 데이터의 스냅샷을 만들고 이를 구독자에게 복사하는 것으로 시작된다.
완료 시 게시자의 변경 사항이 실시간으로 구독자에게 전송된다.
구독자는 단일 구독 내의 게시에 대해 트랜잭션 일관성이 보장되도록 게시자와 동일한 순서로 데이터를 적용한다.
이 데이터 복제 방법을 트랜잭션 복제라고도 한다.

## 구조

게시자 DB의 데이터 스냅샷을 복사하여 논리적 복제를 시작한다.
완료되면 게시자의 변경 사항이 실시간으로 발생하는 대로 구독자에게 전송된다.
구독자는 단일 구독 내의 게시에 대해 트랜잭션 일관성이 보장되도록 게시자에서 커밋된 순서대로 데이터를 적용한다.

논리적 복제는 물리적 스트리밍 복제와 유사한 구조로 구축된다.
walsender와 apply 프로세스에 의해 구현된다.
walsender 프로세스는 WAL의 논리적 디코딩을 시작하고 표준 논리적 디코딩 플러그인(pgoutput)을 로드한다.
플러그인은 WAL에서 읽은 변경 사항을 논리적 복제 프로토콜로 변환하고 게시 사양에 따라 데이터를 필터링한다.
그 후 데이터는 스트리밍 복제 프로토콜을 사용하여 적용 작업자에게 지속적으로 전송되며, 적용 작업자는 데이터를 로컬 테이블에 매핑하고 수신된 개별 변경 사항을 올바른 트랜잭션 순서로 적용한다.

구독자 DB의 적용 프로세스는 항상 `session_replication_role`이 `replica`로 설정된 상태로 실행된다.
기본적으로 트리거와 규칙은 구독자에서 실행되지 않는다.
사용자는 선택적으로 `ALTER TABLE` 명령과 `ENABLE TRIGGER`와 `ENABLE RULE` 절을 사용해 테이블에서 트리거와 규칙을 활성화하도록 선택 가능하다.

논리적 복제 적용 프로세스는 현재 명령문 트리거가 아닌 행 트리거만 실행한다.
초기 테이블 동기화는 COPY 명령처럼 구현되므로 `INSERT`에 대한 행과 명령문 트리거를 모두 실행한다.

### 초기 스냅샷

기존 구독 테이블의 초기 데이터는 특별한 종류의 적용 프로세스의 병렬 인스턴스에서 스냅샷을 생성하고 복사된다.
이 프로세스는 자체 임시 복제 슬롯을 생성하고 기존 데이터를 복사한다.
기존 데이터가 복사되면 작업자는 동기화 모드로 들어간다.
동기화모드는 표준 논리적 복제를 사용하여 초기 데이터 복사 중 발생한 모든 변경 사항을 스트리밍 하여 테이블이 기본 적용 프로세스와 동기화된 상태가 되도록 한다.
동기화가 완료되면 복제가 정상적으로 계속되는 기본 적용 프로세스에 테이블 복제 제어가 다시 제공된다.

스냅샷 생김새

```bash
vxid:3/28738
pid:18053
dbid:13881
iso:2
ro:0
xmin:926
xmax:926
xcnt:0
sof:0
sxcnt:0
rec:0
```

